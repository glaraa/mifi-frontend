import React, { useState, useEffect } from "react";
import { fetchUserRequests, acceptBuddyRequest, rejectBuddyRequest } from "../api"; 
import Navbar from "./Navbar";
import "./AddBuddies.css";

const BuddyRequest = () => {
  const [userData, setUserData] = useState(null);
  const [userRequests, setUserRequests] = useState([]);

  // Fetch user data and requests
  useEffect(() => {
    const fetchData = async () => {
      try {
        const userResponse = await fetchUserData(); // Replace with actual API call
        setUserData(userResponse);

        const requestsResponse = await fetchUserRequests(userResponse.userId); // Replace with actual API call
        setUserRequests(requestsResponse);
      } catch (error) {
        console.error("Error fetching data:", error);
      }
    };

    fetchData();
  }, []);

  const handleAccept = async (userName) => {
    try {
      await acceptBuddyRequest(userName); 
      setUserRequests((prevRequests) =>
        prevRequests.filter((req) => req.userName !== userName)
      );
    } catch (error) {
      console.error("Error accepting buddy request:", error);
    }
  };

  const handleReject = async (userName) => {
    try {
      await rejectBuddyRequest(userName); 
      setUserRequests((prevRequests) =>
        prevRequests.filter((req) => req.userName !== userName)
      );
    } catch (error) {
      console.error("Error rejecting buddy request:", error);
    }
  };

  return (
    <div>
      <Navbar user={userData} />
      <section className="row justify-content-center mt-3">
        <div className="card" style={{ maxWidth: "42rem", marginLeft: "5%", opacity: "0.95" }}>
          <div className="card-body">
            <h5>Buddy Requests</h5>
            <div className="col-md-12 col-sm-12">
              <div className="requests justify-content-between mb-3">
                {userRequests.map((req, index) => (
                  <div className="buddy-req" key={index}>
                    <div className="row">
                      <div className="col-md-2 col-sm-1">
                        <img
                          src={req.userProPic}
                          style={{
                            maxWidth: "3rem",
                            maxHeight: "3rem",
                            minWidth: "3rem",
                            minHeight: "3rem",
                            borderRadius: "50%",
                          }}
                          alt="user"
                          className="profile-photo-lg"
                        />
                      </div>
                      <div className="col-md-5 col-sm-3">
                        <h5>
                          <a href={`/user/bud_profile/${req.userName}`} className="profile-link">
                            {req.firstName} {req.lastName}
                          </a>
                        </h5>
                        <p>Makes {req.category}</p>
                      </div>
                      <div className="col-md-2 col-sm-9">
                        <button className="btn btn-success" onClick={() => handleAccept(req.userName)}>
                          Accept
                        </button>
                      </div>
                      <div className="col-md-3 col-sm-1">
                        <button className="btn btn-danger" onClick={() => handleReject(req.userName)}>
                          Reject
                        </button>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>
  );
};

export default BuddyRequest;
